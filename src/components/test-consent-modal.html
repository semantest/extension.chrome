<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConsentModal.js Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 14px;
        }
        
        button.primary {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        h2 {
            color: #333;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <h1>ConsentModal.js Test Page</h1>
    
    <h2>Test Methods:</h2>
    
    <button class="primary" onclick="testDirectShow()">
        Test Direct Show
    </button>
    
    <button class="primary" onclick="testMessage()">
        Test SHOW_TELEMETRY_CONSENT_MODAL Message
    </button>
    
    <button onclick="checkStorage()">
        Check Chrome Storage
    </button>
    
    <button onclick="clearStorage()">
        Clear Storage
    </button>
    
    <div id="result" class="result" style="display: none;"></div>
    
    <h2>Expected Behavior:</h2>
    <ul>
        <li>Modal appears with clean design</li>
        <li>Yes/No buttons work correctly</li>
        <li>Privacy policy link opens in new tab</li>
        <li>Storage updates with consent choice</li>
        <li>telemetryConsentPending flag is cleared</li>
        <li>Toast notification shows after choice</li>
        <li>ESC key triggers "No" choice</li>
        <li>Cannot close by clicking overlay</li>
    </ul>

    <script src="ConsentModal.js"></script>
    <script>
        // Mock chrome API for testing
        if (!window.chrome || !window.chrome.storage) {
            window.chrome = {
                storage: {
                    sync: {
                        set: (data) => {
                            console.log('Storage SET:', data);
                            const existing = JSON.parse(localStorage.getItem('chromeStorage') || '{}');
                            Object.assign(existing, data);
                            localStorage.setItem('chromeStorage', JSON.stringify(existing));
                            showResult('Storage updated: ' + JSON.stringify(data, null, 2));
                            return Promise.resolve();
                        },
                        get: (keys) => {
                            const storage = JSON.parse(localStorage.getItem('chromeStorage') || '{}');
                            console.log('Storage GET:', storage);
                            return Promise.resolve(storage);
                        },
                        remove: (keys) => {
                            console.log('Storage REMOVE:', keys);
                            const storage = JSON.parse(localStorage.getItem('chromeStorage') || '{}');
                            if (Array.isArray(keys)) {
                                keys.forEach(key => delete storage[key]);
                            } else {
                                delete storage[keys];
                            }
                            localStorage.setItem('chromeStorage', JSON.stringify(storage));
                            showResult('Storage removed: ' + keys);
                            return Promise.resolve();
                        }
                    }
                },
                runtime: {
                    sendMessage: (message, callback) => {
                        console.log('Message sent:', message);
                        
                        // Simulate the message handler
                        if (message.action === 'SHOW_CONSENT_MODAL' || 
                            message.action === 'SHOW_TELEMETRY_CONSENT_MODAL') {
                            const modal = new ConsentModal();
                            modal.show((consent) => {
                                if (callback) callback({ consent: consent });
                                showResult('Message response: consent = ' + consent);
                            });
                        } else {
                            showResult('Message sent: ' + JSON.stringify(message));
                        }
                    },
                    onMessage: {
                        addListener: (listener) => {
                            window.chromeMessageListener = listener;
                            console.log('Message listener added');
                        }
                    }
                },
                tabs: {
                    create: (options) => {
                        console.log('Opening URL:', options.url);
                        window.open(options.url, '_blank');
                    }
                }
            };
        }
        
        function showResult(message) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = message + '\n\nTimestamp: ' + new Date().toISOString();
        }
        
        function testDirectShow() {
            showResult('Testing direct show method...');
            const modal = new ConsentModal();
            modal.show((consent) => {
                showResult('Direct show result: User chose ' + (consent ? 'YES' : 'NO'));
            });
        }
        
        function testMessage() {
            showResult('Testing SHOW_TELEMETRY_CONSENT_MODAL message...');
            
            // Test the exact message format
            chrome.runtime.sendMessage({
                action: 'SHOW_TELEMETRY_CONSENT_MODAL'
            }, (response) => {
                showResult('Message test result: ' + JSON.stringify(response));
            });
        }
        
        async function checkStorage() {
            const storage = await chrome.storage.sync.get([
                'telemetryConsent', 
                'telemetryConsentTimestamp', 
                'telemetryConsentPending'
            ]);
            
            showResult('Current storage state:\n' + JSON.stringify(storage, null, 2));
        }
        
        async function clearStorage() {
            localStorage.removeItem('chromeStorage');
            showResult('Storage cleared!');
        }
        
        // Also test with the original message format
        if (window.chromeMessageListener) {
            console.log('Ready to receive messages');
        }
    </script>
</body>
</html>